<?php
include('adm_operations.php');
$operations = new adm_operations();
include('session_check.php');
include('school_timeout.php');
include('header.php');

$page_title         = isset($_GET['title']) ? $_GET['title'] : 'All masters data';;
$page_category      = isset($_GET['category']) ? trim($_GET['category']) : '';
$key_label          = isset($_GET['key_label']) ? $_GET['key_label'] : 'Key Code';
$display_label      = isset($_GET['display_label']) ? $_GET['display_label'] : 'Display Value';
$parent_category    = isset($_GET['parent_category']) ? $_GET['parent_category'] : '';
$parent_key         = isset($_GET['parent_key']) ? $_GET['parent_key'] : '';
$need_key           = isset($_GET['need_key']) ? $_GET['need_key'] : 'false';
$parent_label       = isset($_GET['parent_label']) ? $_GET['parent_label'] : '';

$me         = $_SESSION['child']['auth_id'];
$school_id  = $_SESSION['child']['log_school_id'];
$acdid      = $_SESSION['child']['choosen_academic_id'];

$showList = true;
$action = (isset($_POST['action']) && trim($_POST['action']) != '') ? trim($_POST['action']) : "list";
$id = (isset($_POST['id']) && trim($_POST['id']) != '') ? trim($_POST['id']) : 0;

$crud = new DbConnect("ced_t_lookups");
if ($parent_category != "") {
    $parentOpts = $crud->search("SELECT id,key_value, disp_value FROM ced_t_lookups WHERE category ='$parent_category' AND school_id = $school_id");
}

function getRefs()
{
    global $crud, $id, $school_id;
    $refs = $crud->search("
        SELECT 1 AS used, concat('Used as a parent for: ', disp_value, ' Category: ', category) as used_at FROM ced_t_lookups WHERE parent_id = $id AND school_id = $school_id
        UNION ALL
        SELECT 1 , concat('Used for student: ', student_firstname, ' ', student_lastname ) 
        FROM ced_t_students WHERE (gender_id = $id OR religion_id = $id OR caste_id = $id OR house_id = $id) AND school_id = $school_id
        UNION ALL
        SELECT 1, concat('Used for teacher: ', staff_name) FROM ced_t_school_staff WHERE teacher_type = $id AND school_id = $school_id
        UNION ALL
        SELECT 1, concat('Used for subject: ', subject_name) FROM ced_t_subjects WHERE subject_group_id = $id AND school_id = $school_id
        UNION ALL
        SELECT 1, concat('Used for subject: ', s.subject_name) FROM ced_t_subject_to_skills ss
        JOIN ced_t_subjects s ON s.subject_id = ss.subject_id WHERE skill_id = $id AND school_id = $school_id GROUP BY s.subject_name
        UNION ALL
        SELECT DISTINCT 1, concat('Used for student: ', student_firstname, ' ', student_lastname , ' for exam: ', e.exam_name) FROM ced_t_students_marks sm
        JOIN ced_t_students s ON s.student_id = sm.student_id AND sm.exam_attendance_id > 0
        JOIN ced_t_exam_names e ON e.exam_id = sm.exam_id
        WHERE ( sm.exam_attendance_id = $id OR sm.grade=$id OR sm.result = $id OR sm.activity_id = $id ) AND e.school_id = $school_id
        UNION ALL
        SELECT DISTINCT 1, concat('Used for exam: ', e.exam_name) FROM ced_t_exam_names e
        JOIN ced_t_exam_timetable et ON et.exam_id = e.exam_id WHERE ( et.activity_id = $id ) AND e.school_id = $school_id
    ");
    if (count($refs) > 0) {
        return $refs;
    }
    return array(array('used' => false, 'used_at' => ''));
}
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    switch ($action) {
        case 'list':
            break;

        case 'create':
        case 'update':
            if (!isset($_POST['disp_value']) || trim($_POST['disp_value']) == '') {
                echo $display_label . " cannot be empty";
                break;
            }
            if (trim($page_category) == '') {
                echo $page_category . " cannot be empty";
                break;
            }
            $lookupData = array(
                "key_value"     => ($need_key == 'true' ? $_POST['key_value'] : $_POST['disp_value']),
                "disp_value"    => $_POST['disp_value'],
                "category"      => $page_category,
                "school_id"     => $school_id,
                "parent_id"     => isset($_POST['parent_id']) ? $_POST['parent_id'] : null
            );
            if ($id > 0) {
                $lookupData['updated_by'] = $me;
                $crud->update($id, $lookupData);
            } else {
                $lookupData['created_by'] = $me;
                $crud->create($lookupData);
            }
            unset($_POST);
            break;

        case 'delete':
            if ($id > 0) {
                $recs = getRefs();
                $okToDelete = true;
                foreach ($recs as $rec) {
                    if ($rec['used'] == true) {
                        $okToDelete = false;
                        break;
                    }
                }
                if ($okToDelete) {
                    $crud->delete($id);
                    unset($_POST);
                } else {
                    echo '<br><p class="bg-warning"> ' . "First delete the following References : </p>";
                    foreach ($recs as $i => $rec) {
                        if ($rec['used'] == true) {
                            echo '<p class="bg-danger"> ' . ($i + 1) . ". " . $rec['used_at'] . "</p>";
                        }
                    }
                }
            }
            break;
        case 'reset':
            unset($_POST);
            break;
        default:
            echo "Invalid action";
            break;
    }
}
$allRecords = array();
if ($showList) {
    $sql = "*";
    if ($page_category != "" && $page_category != "All") {
        if ($parent_category != "") {
            $sql = "SELECT pl.disp_value as parent_disp_value, l.* FROM ced_t_lookups l, ced_t_lookups pl 
            WHERE l.parent_id = pl.id and l.category = '$page_category' and l.school_id = $school_id";
        } else {
            $sql = "SELECT * FROM ced_t_lookups WHERE category ='$page_category' AND school_id = $school_id";
        }
    }
    $allRecords = $crud->search($sql);
}
?>

<button id="backButton" style="padding: 8px 16px; font-size: 14px; font-family: Arial, sans-serif; background-color: #f0f0f0; color: #333; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); margin-top: 10px; position: sticky; top: 10px; z-index: 1000;"> &#8592; Back </button>

<div class="container" style="margin-top:15px;">
    <div class="panel panel-default">
        <div class="panel-heading" style="text-transform: uppercase;"><?php echo $page_title;  ?></div>
        <form action="" method="POST" style="padding: 10px;">
            <input type="hidden" name="action" value="<?php echo isset($_POST['id']) ? 'update' : 'create'; ?>">
            <?php if (isset($_POST['id'])) : ?>
                <input type="hidden" name="id" name="id" value="<?php echo $_POST['id']; ?>">
            <?php endif; ?>

            <?php if ($parent_category != "") { ?>
                <div class="form-group">
                    <label for="parent_id"><?php echo $parent_label; ?></label>
                    <select required class="form-control" id="parent_id" name="parent_id" style="width: 100% !important;">
                        <option selected="selected" value="0">--Select <?php echo $parent_label; ?>--</option>
                        <?php
                        foreach ($parentOpts as $o) {
                            echo "<option value='" . ($parent_key == 'id' ? $o["id"] : $o["key_value"]) . "'>" . $o["disp_value"] . "</option>";
                        }
                        ?>
                    </select>
                </div>
            <?php }; ?>
            <?php if ($need_key == "true") { ?>
                <div class="form-group">
                    <label for="key_value"><?php echo $key_label; ?></label>
                    <input required class="form-control" type="text" name="key_value" id="key_value" value="<?php echo isset($_POST['key_value']) ? $_POST['key_value'] : ''; ?>" required>
                </div>
            <?php }; ?>
            <div class="form-group">
                <label for="disp_value"><?php echo $display_label; ?></label>
                <input required class="form-control" type="text" name="disp_value" id="disp_value" value="<?php echo isset($_POST['disp_value']) ? $_POST['disp_value'] : ''; ?>" required>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-default"><?php echo isset($_POST['id']) ? 'Update Record' : 'Create Record'; ?></button>
                <button type="button" class="btn btn-default" onClick="resetForm()">Reset</button>
            </div>
        </form>
    </div>

    <form id="reset_form" action="" method="POST">
        <input type="hidden" name="action" value="reset">
    </form>
    <form action="" method="POST" name="deleteForm" id="deleteForm">
        <input type="hidden" id="action" name="action" value="delete">
        <input type="hidden" id="id" name="id" />
    </form>


    <?php if (isset($allRecords)) : ?>
        <div class="table-responsive">
            <table id="lookup_form" class="table table-condensed table-hover">
                <thead>
                    <tr>
                        <th>Sl. No.</th>
                        <?php if ($need_key == "true") { ?> <th><?php echo $key_label; ?></th> <?php } ?>
                        <th><?php echo $display_label; ?></th>
                        <th>Category</th>
                        <?php if ($parent_category != "") { ?> <th><?php echo $parent_label; ?></th> <?php } ?>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($allRecords as $index => $record) : ?>
                        <tr>
                            <td><?php echo $index + 1; ?></td>
                            <?php if ($need_key == "true") { ?> <th><?php echo $record['key_value']; ?></th> <?php } ?>
                            <td><?php echo $record['disp_value']; ?></td>
                            <td><?php echo $record['category']; ?></td>
                            <?php if ($parent_category != "") { ?> <td><?php echo $record['parent_disp_value']; ?></td> <?php } ?>
                            <td>
                                <div class="row">
                                    <div class="col-md-1">
                                        <form class="form-inline" method="POST">
                                            <!-- <input type="hidden" name="action" value="edit"> -->
                                            <input type="hidden" name="id" value="<?php echo $record['id']; ?>">
                                            <input type="hidden" name="key_value" value="<?php echo $record['key_value']; ?>">
                                            <input type="hidden" name="disp_value" value="<?php echo $record['disp_value']; ?>">
                                            <input type="hidden" name="category" value="<?php echo $record['category']; ?>">
                                            <input type="hidden" name="parent_id" value="<?php echo $record['parent_id']; ?>">
                                            <button title="Edit" type="submit" class="btn btn-link" style="padding:5px;">
                                                <span class="glyphicon glyphicon-pencil"></span>
                                            </button>
                                        </form>
                                    </div>
                                    <div class="col-md-1">
                                        <button title="Delete" onClick="confirmAndDelete(
                                            <?php echo '\'' . $record['id'] . '\',' . '\'' . $record['disp_value'] . '\''; ?>
                                            )" class="btn btn-link ">
                                            <span class="glyphicon glyphicon-remove"></span>
                                        </button>
                                    </div>
                                </div>


                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    <?php endif; ?>
</div>

<!-- JavaScript -->
<!-- <script src="//code.jquery.com/jquery-1.12.0.min.js"></script> -->
<script src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
<script>
    document.getElementById('backButton').addEventListener('click', function () {
        // Check if there's a referrer (previous page)
        if (document.referrer) {
            sessionStorage.setItem('resetFormOnLoad', 'true'); // signal to reset on previous page
            window.location.href = document.referrer; // go back to previous page
        } else {
            window.history.back(); // fallback to browser history
        }
    });
    
    function resetForm() {
        var f = document.getElementById("reset_form");
        f.submit();
    }

    function confirmAndDelete(id, name) {
        var res = confirm("Do you want to delete this record: " + name + "?");
        if (res) {
            document.querySelector("#deleteForm input#id").value = id;
            document.querySelector("#deleteForm input#action").value = "delete";
            document.getElementById("deleteForm").submit();
        }
    }
    // DataTable initialization
    $(document).ready(function() {
        $('#lookkup_table').dataTable();
        //document.getElementById("parent_id").value = selected_lookup_parent_id;
        <?php
        if (isset($_POST['parent_id']) && $_POST['parent_id'] != "") {
            echo 'document.getElementById("parent_id").value = ' . $_POST['parent_id'];
        };
        ?>
    });
</script>